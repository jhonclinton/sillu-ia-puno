<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sillu-IA: Edge Computing Puno</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icono.png">

    <script src="libs/tf.min.js"></script>
    <script src="libs/mobilenet.js"></script>
    <script src="libs/knn-classifier.js"></script>

    <style>
        :root { --primary: #1a73e8; --success: #2e7d32; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        header { width: 100%; background: var(--primary); color: white; padding: 15px 0; font-weight: bold; font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .main-card { width: 92%; max-width: 450px; background: white; margin-top: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 15px; box-sizing: border-box; }
        
        #video-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; background: #000; aspect-ratio: 4/3; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .status-badge { font-size: 0.75rem; padding: 5px 12px; border-radius: 20px; margin: 10px 0; display: inline-block; font-weight: bold; }
        .status-loading { background: #fff3e0; color: #ef6c00; }
        .status-ready { background: #e8f5e9; color: var(--success); }

        .result-area { margin-top: 10px; padding: 20px; border-top: 1px solid #eee; }
        #prediction-text { font-size: 1.6rem; color: var(--primary); margin: 5px 0; font-weight: 800; }
        #confidence-bar { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin-top: 10px; position: relative; }
        #confidence-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 4px; transition: width 0.3s; }
        
        .footer-data { font-size: 0.7rem; color: #999; margin-top: 15px; display: flex; justify-content: space-between; width: 100%; }
    </style>
</head>
<body>

    <header>Sillu-IA: Guía de Patrimonio</header>

    <div class="main-card">
        <div id="status" class="status-badge status-loading">Iniciando Inteligencia...</div>
        
        <div id="video-container">
            <video id="webcam" autoplay playsinline muted></video>
        </div>

        <div class="result-area">
            <p style="margin:0; font-size:0.7rem; color:#666; text-transform:uppercase;">Identificado:</p>
            <h2 id="prediction-text">Escaneando...</h2>
            <div id="confidence-text" style="font-size: 0.85rem; color: #555;">Esperando señal</div>
            <div id="confidence-bar"><div id="confidence-fill"></div></div>
        </div>

        <div class="footer-data">
            <span id="latency-val">Latencia: -- ms</span>
            <span>Edge Computing Puno v1.0</span>
        </div>
    </div>

<script>
    // 1. Registro del Service Worker para funcionamiento Offline real
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(reg => {
                console.log('SW registrado para modo offline');
            }).catch(err => console.log('Error SW', err));
        });
    }

    const video = document.getElementById('webcam');
    const statusBox = document.getElementById('status');
    const predictionLabel = document.getElementById('prediction-text');
    const confidenceLabel = document.getElementById('confidence-text');
    const confidenceFill = document.getElementById('confidence-fill');
    const latencyLabel = document.getElementById('latency-val');

    let net;
    const classifier = knnClassifier.create();
    
    // Tus 5 clases en el orden exacto de entrenamiento
    const CLASES = [
        'Chullpas Sillustani', 
        'Inca Uyo (Chucuito)', 
        'Aramu Muru (Ilave)', 
        'Catedral de Puno', 
        'Arco de Deustua'
    ];

    async function app() {
        try {
            // Iniciar cámara trasera por defecto
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" }, 
                audio: false 
            });
            video.srcObject = stream;

            // Cargar MobileNet
            statusBox.innerText = "Cargando motor base...";
            net = await mobilenet.load();

            // Cargar el modelo que descargaste (.json)
            statusBox.innerText = "Cargando conocimiento de Puno...";
            const response = await fetch('modelo_puno_final.json');
            if (!response.ok) throw new Error("No se halló el JSON");
            
            const datasetJson = await response.json();
            const tensors = Object.fromEntries(
                Object.entries(datasetJson).map(([label, data]) => [
                    label, 
                    tf.tensor(data, [data.length / 1024, 1024])
                ])
            );
            
            classifier.setClassifierDataset(tensors);

            statusBox.innerText = "SISTEMA OFFLINE LISTO";
            statusBox.className = "status-badge status-ready";

            runPrediction();
        } catch (error) {
            statusBox.innerText = "Error: Verifica archivos locales";
            console.error(error);
        }
    }

    async function runPrediction() {
        while (true) {
            const t0 = performance.now();
            
            const img = tf.browser.fromPixels(video);
            const activation = net.infer(img, 'conv_preds');
            const result = await classifier.predictClass(activation);

            if (result.confidences[result.label] > 0.65) {
                const nombreClase = CLASES[result.label];
                const probabilidad = (result.confidences[result.label] * 100).toFixed(1);
                
                predictionLabel.innerText = nombreClase;
                confidenceLabel.innerText = `Confianza: ${probabilidad}%`;
                confidenceFill.style.width = probabilidad + "%";
            } else {
                predictionLabel.innerText = "Escaneando...";
                confidenceLabel.innerText = "Apunta al monumento";
                confidenceFill.style.width = "0%";
            }

            const t1 = performance.now();
            latencyLabel.innerText = `Latencia: ${(t1 - t0).toFixed(0)} ms`;
            
            img.dispose();
            await tf.nextFrame();
        }
    }

    app();
</script>
</body>
</html>