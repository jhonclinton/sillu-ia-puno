<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sillu-IA: Edge Computing v2</title>
    <link rel="manifest" href="manifest.json">
    <script src="libs/tf.min.js"></script>
    <script src="libs/mobilenet.js"></script>
    <script src="libs/knn-classifier.js"></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; text-align: center; }
        header { background: var(--primary); color: white; padding: 15px; font-weight: bold; }
        .main-card { width: 92%; max-width: 450px; background: white; margin: 15px auto; border-radius: 20px; shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 15px; box-sizing: border-box; }
        video { width: 100%; border-radius: 15px; background: #000; }
        
        /* Monitor de Clases para Tesis */
        .debug-panel { text-align: left; font-size: 0.7rem; background: #eee; padding: 10px; border-radius: 10px; margin-top: 10px; }
        .class-row { display: flex; justify-content: space-between; margin: 2px 0; }
        .bar-bg { width: 60%; background: #ddd; height: 8px; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }

        #prediction-text { font-size: 1.5rem; color: var(--primary); font-weight: bold; margin: 10px 0; }
        #status { font-size: 0.8rem; color: #2e7d32; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <header>Sillu-IA: Reconocimiento Puno</header>

    <div class="main-card">
        <div id="status">Iniciando...</div>
        <video id="webcam" autoplay playsinline muted></video>

        <div id="prediction-text">Escaneando...</div>

        <div class="debug-panel" id="debug-panel">
            <strong>Confianza por clase:</strong>
            <div id="monitor-clases"></div>
        </div>
        
        <div style="font-size: 0.6rem; color: #aaa; margin-top: 10px;">
            Si no cambia, borra el caché de Chrome y recarga.
        </div>
    </div>

<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    const video = document.getElementById('webcam');
    const statusBox = document.getElementById('status');
    const predictionLabel = document.getElementById('prediction-text');
    const monitor = document.getElementById('monitor-clases');

    let net;
    const classifier = knnClassifier.create();
    
    // IMPORTANTE: El mismo orden de tu entrenamiento
    const CLASES = ['Chullpas Sillustani', 'Inca Uyo', 'Aramu Muru', 'Catedral Puno', 'Arco Deustua'];

    async function setup() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;

            net = await mobilenet.load();
            
            // Forzar carga fresca del JSON (agregando un número aleatorio para evitar caché)
            const response = await fetch('modelo_puno_final.json?v=' + Math.random());
            const datasetJson = await response.json();
            
            const tensors = Object.fromEntries(
                Object.entries(datasetJson).map(([label, data]) => [
                    label, 
                    tf.tensor(data, [data.length / 1024, 1024])
                ])
            );
            
            classifier.setClassifierDataset(tensors);
            statusBox.innerText = "SISTEMA LISTO (EDGE MODE)";
            
            // Crear barras de monitor
            CLASES.forEach((nombre, i) => {
                monitor.innerHTML += `
                    <div class="class-row">
                        <span>${nombre}</span>
                        <div class="bar-bg"><div id="bar-${i}" class="bar-fill"></div></div>
                    </div>`;
            });

            run();
        } catch (e) {
            statusBox.innerText = "Error de carga. ¿Subiste el JSON?";
            console.error(e);
        }
    }

    async function run() {
        while (true) {
            const img = tf.browser.fromPixels(video);
            const activation = net.infer(img, 'conv_preds');
            const result = await classifier.predictClass(activation);

            // Actualizar monitor visual
            CLASES.forEach((_, i) => {
                const conf = result.confidences[i] || 0;
                document.getElementById(`bar-${i}`).style.width = (conf * 100) + "%";
            });

            // Lógica de decisión: Bajamos el umbral a 0.45 para Android
            if (result.confidences[result.label] > 0.45) {
                predictionLabel.innerText = CLASES[result.label];
            } else {
                predictionLabel.innerText = "Buscando...";
            }

            img.dispose();
            await tf.nextFrame();
        }
    }

    setup();
</script>
</body>
</html>
